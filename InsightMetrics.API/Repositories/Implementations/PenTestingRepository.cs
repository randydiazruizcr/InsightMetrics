using ForsyteIT.CosmosAPI.CRUDS.Guardian;
using ForsyteIT.CosmosAPI.Models.CollectionTypes;
using ForsyteIT.CosmosAPI.Models.Guardian;
using InsightMetrics.API.Models.PenTest;
using InsightMetrics.API.Repositories.Interfaces;

namespace InsightMetrics.API.Repositories.Implementations
{
    /// <summary>
    /// Repository implementation for retrieving penetration testing schedule data.
    /// </summary>
    public class PenTestingRepository : IPenTestingRepository
    {
        /// <summary>
        /// Retrieves the penetration testing schedule for the specified client.
        /// </summary>
        /// <param name="clientId">The unique identifier of the client.</param>
        /// <returns>
        /// A <see cref="PenTestSchedule"/> object containing the pen test type,
        /// last pen test date, and next scheduled pen test date.
        /// </returns>
        public async Task<PenTestSchedule> GetPenTestScheduleAsync(string clientId)
        {
            CrudCsamSales CrudCsamSales = new();
            List<CsamSales> Sales = await CrudCsamSales.Get(q => q.CompanyId == clientId && q.CollectionType == CollectionTypeGuardian.CsamSales);
            if (Sales.Count > 0)
            {
                CsamSales CsamSales = Sales[0];
                return new PenTestSchedule()
                {
                    Id = CsamSales.Id,
                    Type = CsamSales.PenTesting,
                    LastPenTest = CsamSales.LastPenTest,
                    NextPentTest = CsamSales.NextPentTest,
                };
            }
            return new PenTestSchedule();
        }
    }
}
